# GitHub Actions CI/CD Pipeline for Binky
#
# Trigger: push tags matching v* (e.g. v0.1.0)
#
# Build job (matrix: aarch64 + x64):
#   - Builds Tauri app
#   - Creates PKG installer → uploaded directly to GitHub Release
#   - Updater artifacts (.app.tar.gz + .sig) → uploaded as Actions artifacts
#
# Publish job (after both builds):
#   - Deploys updater artifacts + latest.json to GitHub Pages (myedithub.github.io/binky/)
#   - Updates release description with notes, download table, installation guide
#   - Result: release only shows .pkg files; updater files live on gh-pages

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            target: aarch64-apple-darwin
            arch: aarch64
          - platform: 'macos-latest'
            target: x86_64-apple-darwin
            arch: x64

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: false
          key: 'arm-i8mm-v2'

      - name: Cache sherpa-onnx downloads
        id: sherpa-cache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/sherpa-rs
          key: sherpa-onnx-${{ matrix.arch }}-v1

      - name: Force sherpa-rs-sys rebuild on ONNX cache miss
        if: steps.sherpa-cache.outputs.cache-hit != 'true'
        run: find src-tauri/target -name "sherpa-rs-sys-*" -path "*/build/*" -type d | xargs rm -rf 2>/dev/null || true

      - name: Install cmake (required by whisper-rs)
        run: brew install cmake || true

      - name: Decrypt Tauri signing key
        run: |
          gpg --quiet --batch --yes --decrypt \
            --passphrase="${{ secrets.GPG_PASSPHRASE }}" \
            --output /tmp/signing.key .github/binky-signing.key.gpg

      - name: Clear whisper-rs-sys cmake cache
        if: matrix.arch == 'aarch64'
        run: |
          find src-tauri/target -path "*whisper*" -name "CMakeCache.txt" -delete 2>/dev/null || true
          find src-tauri/target -path "*whisper*" -name "*.o" -delete 2>/dev/null || true

      - name: Set ARM compiler flags (required by whisper-rs ggml i8mm)
        if: matrix.arch == 'aarch64'
        run: |
          echo "CFLAGS=-march=armv8.5-a+i8mm" >> $GITHUB_ENV
          echo "CXXFLAGS=-march=armv8.5-a+i8mm" >> $GITHUB_ENV

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        run: |
          export TAURI_SIGNING_PRIVATE_KEY="$(cat /tmp/signing.key)"
          export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="tauri"
          npm run tauri build -- --target ${{ matrix.target }}
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Bundle sherpa-onnx dylibs into app
        run: |
          BUNDLE="src-tauri/target/${{ matrix.target }}/release/bundle/macos/Binky.app"
          SHERPA_LIB_DIR=$(find ~/Library/Caches/sherpa-rs -name "libonnxruntime*.dylib" -exec dirname {} \; | head -1)

          if [ -z "$SHERPA_LIB_DIR" ]; then
            echo "Error: sherpa-onnx dylibs not found in cache"
            exit 1
          fi

          echo "Bundling all dylibs from: $SHERPA_LIB_DIR"
          mkdir -p "$BUNDLE/Contents/Frameworks"
          cp "$SHERPA_LIB_DIR"/*.dylib "$BUNDLE/Contents/Frameworks/"

          # Fix install name of each bundled dylib to be @rpath-relative
          for dylib in "$BUNDLE/Contents/Frameworks"/*.dylib; do
            name=$(basename "$dylib")
            install_name_tool -id "@rpath/$name" "$dylib"
          done

          # Add rpath to binary so it finds Frameworks/
          install_name_tool -add_rpath "@executable_path/../Frameworks" \
            "$BUNDLE/Contents/MacOS/binky"

          # Re-sign the modified bundle (ad-hoc, no cert needed)
          codesign --force --deep --sign - "$BUNDLE"

      - name: Collect artifacts
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUNDLE="src-tauri/target/${{ matrix.target }}/release/bundle/macos"

          mkdir -p artifacts/release artifacts/updater

          # PKG → release
          mkdir -p /tmp/pkg-scripts
          cp .github/scripts/postinstall /tmp/pkg-scripts/postinstall
          chmod +x /tmp/pkg-scripts/postinstall
          pkgbuild \
            --component "$BUNDLE/Binky.app" \
            --install-location /Applications \
            --scripts /tmp/pkg-scripts \
            --identifier de.binky.app \
            --version "$VERSION" \
            "artifacts/release/Binky_${VERSION}_${{ matrix.arch }}.pkg"

          # Updater → gh-pages
          cp "$BUNDLE/Binky.app.tar.gz"     "artifacts/updater/Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz"
          cp "$BUNDLE/Binky.app.tar.gz.sig" "artifacts/updater/Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz.sig"

      - name: Upload PKG to release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/release/*.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload updater artifacts
        uses: actions/upload-artifact@v4
        with:
          name: updater-${{ matrix.arch }}
          path: artifacts/updater/*
          compression-level: 0

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download updater artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: updater-*
          path: updater
          merge-multiple: true

      - name: Generate latest.json
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BASE_URL="https://myedithub.github.io/binky"

          ARM_SIG=$(cat "updater/Binky_${VERSION}_aarch64.app.tar.gz.sig")
          X64_SIG=$(cat "updater/Binky_${VERSION}_x64.app.tar.gz.sig")

          cat > updater/latest.json << EOF
          {
            "version": "v${VERSION}",
            "notes": "Neue Version verfügbar.",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${ARM_SIG}",
                "url": "${BASE_URL}/Binky_${VERSION}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "${X64_SIG}",
                "url": "${BASE_URL}/Binky_${VERSION}_x64.app.tar.gz"
              }
            }
          }
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./updater
          keep_files: true

      - name: Extract release notes from README
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          NOTES=$(awk "/^### v${VERSION} /{start=1; next} start && /^### v[0-9]/{exit} start && /^## [^#]/{exit} start{print}" README.md | sed '/^[[:space:]]*$/{ N; /^\n$/d; }' | sed '/./,$!d')
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update release description
        uses: softprops/action-gh-release@v1
        with:
          name: 'Binky v${{ steps.version.outputs.VERSION }}'
          body: |
            ${{ steps.notes.outputs.notes }}

            ---

            ## Download

            | Mac-Typ | Download |
            |---------|----------|
            | **Apple Silicon** (M1/M2/M3/M4) | [Download](https://github.com/MyEditHub/binky/releases/download/v${{ steps.version.outputs.VERSION }}/Binky_${{ steps.version.outputs.VERSION }}_aarch64.pkg) |
            | **Intel** | [Download](https://github.com/MyEditHub/binky/releases/download/v${{ steps.version.outputs.VERSION }}/Binky_${{ steps.version.outputs.VERSION }}_x64.pkg) |

            ---

            ## Installation Guide

            macOS blockiert die App, weil sie von einem unabhängigen Entwickler stammt. Folge diesen Schritten:

            1. Lade die `.pkg`-Datei oben herunter
            2. **Doppelklick** — macOS zeigt eine Sicherheitswarnung
            3. **Systemeinstellungen → Datenschutz & Sicherheit** öffnen
            4. **Nach unten scrollen** — du siehst *„Binky wurde blockiert"*
            5. **„Trotzdem öffnen"** klicken → Passwort eingeben
            6. **Installer erneut starten** — jetzt klappt es

            Nach dieser einmaligen Einrichtung öffnet sich die App normal.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
