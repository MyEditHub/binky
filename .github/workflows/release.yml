# GitHub Actions CI/CD Pipeline for Binky
#
# Trigger: push tags matching v* (e.g. v0.1.0) or manual workflow_dispatch
#
# Why manual build instead of tauri-action:
#   - TAURI_SIGNING_PRIVATE_KEY is multi-line; GITHUB_ENV truncates it
#   - Only inline `export KEY="$(cat file)"` reliably passes it to the build
#
# Artifacts produced per architecture:
#   - DMG (disk image)
#   - PKG installer (wraps the .app via pkgbuild)
#   - Updater tar.gz + .sig (for auto-updater)
#   - latest.json (generated after both builds complete)

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            triple: 'aarch64-apple-darwin'
            arch: 'aarch64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            triple: 'x86_64-apple-darwin'
            arch: 'x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: false
          key: 'arm-i8mm-v2'

      - name: Install cmake (required by whisper-rs)
        run: brew install cmake || true

      - name: Decrypt Tauri signing key
        run: |
          gpg --quiet --batch --yes --decrypt \
            --passphrase="${{ secrets.GPG_PASSPHRASE }}" \
            --output /tmp/signing.key .github/binky-signing.key.gpg

      - name: Clear whisper-rs-sys cmake cache
        if: matrix.arch == 'aarch64'
        run: |
          find src-tauri/target -path "*whisper*" -name "CMakeCache.txt" -delete 2>/dev/null || true
          find src-tauri/target -path "*whisper*" -name "*.o" -delete 2>/dev/null || true

      - name: Set ARM compiler flags (required by whisper-rs ggml i8mm)
        if: matrix.arch == 'aarch64'
        run: |
          echo "CFLAGS=-march=armv8.5-a+i8mm" >> $GITHUB_ENV
          echo "CXXFLAGS=-march=armv8.5-a+i8mm" >> $GITHUB_ENV

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        run: |
          export TAURI_SIGNING_PRIVATE_KEY="$(cat /tmp/signing.key)"
          export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="tauri"
          npm run tauri build -- ${{ matrix.args }}
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Create GitHub Release (idempotent)
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Binky ${{ github.ref_name }}" \
            --notes "Neue Version verfügbar. Details im Changelog." \
            --draft=false --prerelease=false 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload updater artifacts
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          BUNDLE="src-tauri/target/${{ matrix.triple }}/release/bundle/macos"
          TAR="$BUNDLE/Binky.app.tar.gz"
          SIG="$BUNDLE/Binky.app.tar.gz.sig"
          # Rename with arch suffix so both builds can coexist in the same release
          cp "$TAR" "Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz"
          cp "$SIG" "Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz.sig"
          gh release upload "${{ github.ref_name }}" \
            "Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz" \
            "Binky_${VERSION}_${{ matrix.arch }}.app.tar.gz.sig" \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build PKG installer
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          APP_PATH="src-tauri/target/${{ matrix.triple }}/release/bundle/macos/Binky.app"
          mkdir -p /tmp/pkg-scripts
          cp .github/scripts/postinstall /tmp/pkg-scripts/postinstall
          chmod +x /tmp/pkg-scripts/postinstall
          pkgbuild \
            --component "$APP_PATH" \
            --install-location /Applications \
            --scripts /tmp/pkg-scripts \
            --identifier de.binky.app \
            --version "$VERSION" \
            "Binky_${VERSION}_${{ matrix.arch }}.pkg"

      - name: Upload PKG
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          gh release upload "${{ github.ref_name }}" "Binky_${VERSION}_${{ matrix.arch }}.pkg" --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-updater:
    needs: build
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate and upload latest.json
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_CLEAN="${VERSION#v}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}"

          # Download sig files uploaded by build jobs
          gh release download "${{ github.ref_name }}" --pattern "*.sig" --dir /tmp/sigs

          ARM_SIG=$(cat "/tmp/sigs/Binky_${VERSION_CLEAN}_aarch64.app.tar.gz.sig")
          X64_SIG=$(cat "/tmp/sigs/Binky_${VERSION_CLEAN}_x64.app.tar.gz.sig")

          cat > /tmp/latest.json << JSON
          {
            "version": "${VERSION}",
            "notes": "Neue Version verfügbar.",
            "pub_date": "${PUB_DATE}",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${ARM_SIG}",
                "url": "${BASE_URL}/Binky_${VERSION_CLEAN}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "${X64_SIG}",
                "url": "${BASE_URL}/Binky_${VERSION_CLEAN}_x64.app.tar.gz"
              }
            }
          }
          JSON

          gh release upload "${{ github.ref_name }}" /tmp/latest.json --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
